---
title: "Measuring Underemployment"
subtitle: 'Trends from 2006 to 2022'
author: "The Underemployment Project"
date: '`r Sys.Date()`'

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
	warning = FALSE,
  embed_fonts = TRUE,
  fig.align = "center",
  fig_caption= TRUE,
  use_bookdown= TRUE,
  toc= FALSE,
  toc_depth= 3
)
```

```{r libraries, include=FALSE}

#### packages needed
if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
if(!require(gridExtra)) install.packages("girdExtra", repos = "http://cran.us.r-project.org")
if(!require(Hmisc)) install.packages("Hmisc", repos = "http://cran.us.r-project.org")
if(!require(sjlabelled)) install.packages("sjlabelled", repos = "http://cran.us.r-project.org")
if(!require(ggthemes)) install.packages("ggthemes", repos = "http://cran.us.r-project.org")
if(!require(ggtext)) install.packages("ggtext", repos = "http://cran.us.r-project.org")
if(!require(ggrepel)) install.packages("ggrepel", repos = "http://cran.us.r-project.org")
if(!require(doBy)) install.packages("doBy", repos = "http://cran.us.r-project.org")
if(!require(sjmisc)) install.packages("sjmisc", repos = "http://cran.us.r-project.org")
if(!require(plotly)) install.packages("plotly", repos = "http://cran.us.r-project.org")
if(!require(flextable)) install.packages("flextable", repos = "http://cran.us.r-project.org")
if(!require(scales)) install.packages("scales", repos = "http://cran.us.r-project.org")
if(!require(ggalt)) install.packages("ggalt", repos = "http://cran.us.r-project.org")
if(!require(janitor)) install.packages("janitor", repos = "http://cran.us.r-project.org")
if(!require(bookdown)) install.packages("bookdown", repos = "http://cran.us.r-project.org")
if(!require(rmdformats)) install.packages("rmdformats", repos = "http://cran.us.r-project.org")
if(!require(htmlwidgets)) install.packages("htmlwidgets", repos = "http://cran.us.r-project.org")
if(!require(widgetframe)) install.packages("widgetframe", repos = "http://cran.us.r-project.org")
if(!require(officer)) install.packages("officer", repos = "http://cran.us.r-project.org")
if(!require(showtext)) install.packages("showtext", repos = "http://cran.us.r-project.org")
if(!require(colorspace)) install.packages("colorspace", repos = "http://cran.us.r-project.org")
if(!require(patchwork)) install.packages("patchwork", repos = "http://cran.us.r-project.org")
if(!require(ggpubr)) install.packages("ggpubr", repos = "http://cran.us.r-project.org")

library(ggalt) # contingency table
library(tidyverse) # several tools for data manipulation
library(haven) # read SPSS, Stata, and SAS data
library(gridExtra) # arrange multiple grid-based plots on a page
library(Hmisc) # many functions useful for data analysis
library(sjmisc) # useful to set Na's
library(sjlabelled) # get_labels function
library(ggthemes) # themes for ggplot2
library(ggtext) # fancy text
library(ggrepel) # help with the position of the labels on ggplot2 graph
library(doBy) # 'do' something to data stratified 'by' some variables
library(plotly) # interactive plots
library(flextable) # formatting tables 
library(scales) # add scale symbols and colour to axis
library(janitor) # add totals to tables
library(rmdformats)
library(htmlwidgets)
library(widgetframe)
library(colorspace) # colour blind friendly pallettes 
library(officer) # to add additional formatting to tables 
library(patchwork) # to put graphs side by side
library(ggpubr)
library(showtext)
  font_add_google("Lato")
  showtext_auto()


```

```{r load data, include=FALSE}

load("../data/LFS_clean.rda")

```




```{r sample, echo=FALSE}

N_total <- LFS_clean %>% 
  group_by(as_factor(year), 
           as_label(quarter)) %>%
  summarise(Population = sum(na.omit(PWT[AGE >= 18 & AGE <= 64])), # everyone between 18 to 64
            Active = sum(PWT[ILODEFR <=2 & AGE >= 18 & AGE <= 64]), # in employment and unemployed between 18 to 64
            Workers = sum(PWT[ILODEFR == 1 & INECAC05 <= 2 & AGE >= 18 & AGE <= 64])) %>% # employee and self-employees between 18 to 64
  rename(Year = `as_factor(year)`,
         Quarter = `as_label(quarter)`) # Total population estimates

```

# Skills-related underemployment

Skills-related underemployment, skills underutilisation or overqualification is defined as a situation of mismatch between the skills needed and the skills offered in the labour market, in which the skills from individuals surpasses the requirements of a job (Rafferty, 2020). Furthemore, skills-related underemployment is a relevant issue for nations and companies alike, in which the full potential and productive capability of employees is not being used (ILO, 2014).
According to ILO (2008), skills-related underemployment is measured through a proxy that compares the relation between the highest qualification held by an employee and their current occupation. In national surveys such as the LFS, this can measured through a normative approach or a statistical approach. For this report it is used a normative approach because according to the literature (Sutherland, 2012; Tarvid, 2012), it allows to standardized the categories of "Overqualified", "Matched" and "Underqualified" through time.
Based on the definitions provided by ILO and ONS, skills-related underemployment has been operationalized as follows:

- Employees' highest qualification is categorised according to the first digit of the International Standard Classification of Education (ISCED-97) and then classified into thee categories. Later, ISCED levels 1 and 2 are assigned as "Low-skilled", levels 3 and 4 are considered "Intermediate", and levels 5 and 6 as "High-skilled".
- Whilst occupations are classified based on the first digit of the International Standard Classification of Occupations (ISCO-88) and categorised into three groups. In this case, occupations with 9 ISCO code are considered "Low-skilled", occupations related to ISCO codes 4, 5, 6, 7 and 8 are assigned to "Intermediate" and occupations coded 1, 2 and 3 as "High-skilled".
- Then, employees are considered as "Overeducated" when their educational level is higher to the occupational group of their current job. 

In addition, for this report it is important to consider the following:

- We do not use the total active population to calculate the underemployment rate, but only those in in employment (employees and self-employed).
- As stated by the ONS (2022), between wave 2 (April-June) of 2020 and wave 1 (January-March) of 2022 LFS sample size was significantly affected due to the effects of the coronavirus pandemic social distancing measures and this organisation has been noted this can affect results from this period.
- Since wave 2 (April-June) of 2011 of the LFS, the ethnicity variables are modified in accordance to census data. Therefore, in this report, this variable was recoded on datasets from wave 2 of 2011 onward to the format previously used between wave 1 of 2006 and wave 1 of 2011 for analysis purposes.

For this report, skills-related underemployment is depicted by personal characteristics, job arrangements, and sector division (geographic and industrial). 

## Trends by personal characteristics 

This section indicates the development of skill-related underemployment between 2006 and 2022 in the UK in terms of gender (men and women), age segments, ethnicity and educational level.

### Men and women

As figure 1 illustrates, the number of individuals from both groups categorised as skills-related underemployed has steadily increased between 2006 to 2022. Nonetheless, although between 2006 and 2008 the number of men and women under this condition was similar, since 2009 to 2022 the gap between women and men has widened by 2,89%.   

```{r normative approach to skills mismatch table, echo=FALSE}

options(digits = 3)

n_skills <- LFS_clean %>% # summary table
  filter(AGE >= 18 & AGE <= 64) %>% 
  filter(ILODEFR == 1) %>% # only people in employment
  filter(INECAC05 %in% c(1, 2)) %>% #only employees and self-employed
  group_by(year, sequence, quarter, SEX, sk_mm) %>% 
  summarise(count = sum(PWT)) %>% 
  group_by(year, sequence, quarter, SEX) %>% 
  # percentage per quarter
  mutate(percentage = count/sum(count)) %>% 
  filter(sk_mm == 1) %>%  #filtering by overeducated
  as_label(.)

```


```{r plot skills overeducated employees, fig.width=9, fig.height=6, fig.fullwidth=TRUE, fig.cap= "workers who have a qualification above the required for their occupation"}

p_nskills <- n_skills %>% 
  ggplot() + 
  geom_line(aes(x = sequence, y = percentage, colour = factor(SEX)), linewidth = 0.5, show.legend = FALSE) +  
  geom_point(aes(x = sequence, y = percentage, colour = factor(SEX)), shape = 15, show.legend = TRUE) +
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(breaks = seq(0,0.3, 0.05), limits = c(0, 0.3), labels =
                       scales::percent_format(accuracy = 1L), expand = c(0,0), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=c(1:68), position = "top",
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  # annotation
  labs(x = "Year", 
       y = "Percentage", 
       title ="Figure 1. Overeducated workers by gender (percentages and totals)",
       subtitle  = "",
       caption = ""
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 5), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        axis.ticks.length.x = unit(0.1, "cm"), 
        legend.position = "top", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

pskills_total <- n_skills %>% 
  ggplot() + 
  geom_bar(aes(x = sequence, y = count, fill = factor(SEX)), stat = "identity", position = "dodge", width=0.9) +   geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_x_continuous(breaks=c(1:68),
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0,2500000,500000), limits = c(0,2500000), labels = comma, expand = c(0,0), sec.axis = dup_axis()) +
  
  # annotation
  labs(x = "Year", 
       y = "Total", 
       title = "",
       #subtitle  = "Totals based on people in employment between 2006 and 2022",
       #caption = c("Note: People in employment (employees and self-employed) between 2006 and 2022")
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "none", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

p_nskills / pskills_total


```


#### Age

In terms of age groups, although it is possible to identify the age group of "Between 18 and 24 years old" as the one with the largest percentage of its members are skills-related underemployment, the majority of individuals under this conditions are part of the "Between 25 and 34 years old" group.  


```{r normative approach to skills mismatch table, echo=FALSE}

options(digits = 3)

n_skills_age <- LFS_clean %>% # summary table
  filter(AGE >= 18 & AGE <= 64) %>% 
  #creating age categories
  mutate(AGE_cat = case_when(AGE %in% 18:24 ~ "Between 18 and 24",
                             AGE %in% 25:34 ~ "Between 25 and 34",
                             AGE %in% 35:44 ~ "Between 35 and 44",
                             AGE %in% 45:54 ~ "Between 45 and 54",
                             AGE %in% 55:64 ~ "Between 55 and 64",
                             is.na(AGE) ~ NA)) %>%
  filter(ILODEFR == 1) %>% # only people in employment
  filter(INECAC05 %in% c(1, 2)) %>% #only employees and self-employed
  group_by(year, sequence, quarter, AGE_cat, sk_mm) %>% 
  summarise(count = sum(PWT)) %>% 
  group_by(year, sequence, quarter, AGE_cat) %>% 
  # percentage per quarter
  mutate(percentage = count/sum(count)) %>% 
  filter(sk_mm == 1) %>%  #filtering by overeducated
  as_label(.)

```

```{r plot skills overeducated employees, fig.width=9, fig.height=6, fig.fullwidth=TRUE, fig.cap= "workers who have a qualification above the required for their occupation"}

p_nskills_age <- n_skills_age %>% 
  ggplot() + 
  geom_line(aes(x = sequence, y = percentage, colour = factor(AGE_cat)), size = 0.5, show.legend = FALSE) +  
  geom_point(aes(x = sequence, y = percentage, colour = factor(AGE_cat)), shape = 15, show.legend = TRUE) +
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(breaks = seq(0,0.3, 0.05), limits = c(0, 0.3), labels =
                       scales::percent_format(accuracy = 1L), expand = c(0,0), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=c(1:68), position = "top",
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  # annotation
  labs(x = "Year", 
       y = "Percentage", 
       title ="Figure 2. Overeducated workers by age (percentages and totals)",
       subtitle  = "",
       caption = ""
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "top", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

pskills_age_total <- n_skills_age %>% 
  ggplot() + 
  geom_bar(aes(x = sequence, y = count, fill = factor(AGE_cat)), stat = "identity", position = "dodge", width=0.9) +   geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_x_continuous(breaks=c(1:68),
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0,2000000,500000), limits = c(0,2000000), labels = comma, expand = c(0,0), sec.axis = dup_axis()) +
  
  # annotation
  labs(x = "Year", 
       y = "Total", 
       title = "",
       #subtitle  = "Totals based on people in employment between 2006 and 2022",
       #caption = c("Note: People in employment (employees and self-employed) between 2006 and 2022")
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "none", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

p_nskills_age / pskills_age_total

```


#### Ethnicity



```{r normative approach to skills mismatch table, echo=FALSE}

options(digits = 3)

n_skills_eth <- LFS_clean %>% # summary table
  filter(AGE >= 18 & AGE <= 64) %>% 
  filter(ILODEFR == 1) %>% # only people in employment
  filter(INECAC05 %in% c(1, 2)) %>% #only employees and self-employed
  group_by(year, sequence, quarter, ETH, sk_mm) %>% 
  summarise(count = sum(PWT)) %>% 
  group_by(year, sequence, quarter, ETH) %>% 
  # percentage per quarter
  mutate(percentage = count/sum(count)) %>% 
  filter(sk_mm == 1) %>%  #filtering by overeducated
  as_label(.)

```


```{r plot skills overeducated employees, fig.width=9, fig.height=6, fig.fullwidth=TRUE, fig.cap= "workers who have a qualification above the required for their occupation"}

p_nskills_eth <- n_skills_eth %>% 
  ggplot() + 
  geom_line(aes(x = sequence, y = percentage, colour = factor(ETH)), size = 0.5, show.legend = FALSE) +  
  geom_point(aes(x = sequence, y = percentage, colour = factor(ETH)), shape = 15, show.legend = TRUE) +
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(breaks = seq(0,0.3,0.05), limits = c(0, 0.3), labels =
                       scales::percent_format(accuracy = 1L), expand = c(0,0), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=c(1:68), position = "top",
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  # annotation
  labs(x = "Year", 
       y = "Percentage", 
       title ="Figure 3. Overeducated workers by ethnic groups (percentages and totals)",
       subtitle  = "",
       caption = ""
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "top", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

pskills_total_eth <- n_skills_eth %>% 
  ggplot() + 
  geom_bar(aes(x = sequence, y = count, fill = factor(ISCED_cat)), stat = "identity", position = "dodge", width=0.9) +   
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_x_continuous(breaks=c(1:68),
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0,3000000,500000), limits = c(0,3000000), labels = comma, expand = c(0,0), sec.axis = dup_axis()) +
  
  # annotation
  labs(x = "Year", 
       y = "Total", 
       title = "",
       #subtitle  = "Totals based on people in employment between 2006 and 2022",
       #caption = c("Note: People in employment (employees and self-employed) between 2006 and 2022")
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "none", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

p_nskills_eth / pskills_total_eth

```


#### Education

Figure 4 highlights the educational level of "Degree or above" as the group with the highest number of individuals categorised as skills-related underemployed throughout 2006 to 2022. Furthermore, although the number of individuals that hold "Higher education" and "GCE, A-level or equivalent" that are overeducated for their jobs has remained steady in this period, the percentage of overeducated employees with a "Degree or above" has increased by 5,99% in this period.

```{r normative approach to skills mismatch table, echo=FALSE}

options(digits = 3)

n_skills_lvl <- LFS_clean %>% # summary table
  filter(AGE >= 18 & AGE <= 64) %>% 
  filter(ILODEFR == 1) %>% # only people in employment
  filter(INECAC05 %in% c(1, 2)) %>% #only employees and self-employed
  group_by(year, sequence, quarter, quali, sk_mm) %>% 
  summarise(count = sum(PWT)) %>% 
  group_by(year, sequence, quarter, quali) %>% 
  # percentage per quarter
  mutate(percentage = count/sum(count)) %>% 
  filter(!is.na(quali) & !quali %in% c("7")) %>% 
  filter(sk_mm == 1) %>%  #filtering by overeducated
  as_label(.)

```


```{r plot skills overeducated employees, fig.width=9, fig.height=6, fig.fullwidth=TRUE, fig.cap= "workers who have a qualification above the required for their occupation"}

p_nskills_lvl <- n_skills_lvl %>% 
  ggplot() + 
  geom_line(aes(x = sequence, y = percentage, colour = factor(quali)), size = 0.5, show.legend = FALSE) +  
  geom_point(aes(x = sequence, y = percentage, colour = factor(quali)), shape = 15, show.legend = TRUE) +
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(breaks = seq(0,0.3,0.05), limits = c(0, 0.3), labels =
                       scales::percent_format(accuracy = 1L), expand = c(0,0), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=c(1:68), position = "top",
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  # annotation
  labs(x = "Year", 
       y = "Percentage", 
       title ="Figure 4. Overeducated workers by educational level (percentages and totals)",
       subtitle  = "",
       caption = ""
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "top", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

pskills_total_lvl <- n_skills_lvl %>% 
  ggplot() + 
  geom_bar(aes(x = sequence, y = count, fill = factor(quali)), stat = "identity", position = "dodge", width=0.9) +   
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_x_continuous(breaks=c(1:68),
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0,3000000,500000), limits = c(0,3000000), labels = comma, expand = c(0,0), sec.axis = dup_axis()) +
  
  # annotation
  labs(x = "Year", 
       y = "Total", 
       title = "",
       #subtitle  = "Totals based on people in employment between 2006 and 2022",
       #caption = c("Note: People in employment (employees and self-employed) between 2006 and 2022")
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "none", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

p_nskills_lvl / pskills_total_lvl

```

## Trends by job characteristics 

Meanwhile, this depicts the distribution of skill-related underemployed individuals in terms of occupational category, work arrangement and flexible employment.


### Occupational category

As for occupational categories, although the group "Intermediate" has the largest proportion of overeducated employees, the majority of individuals under this conditions are related to "routine and semi-routine" occupations. In addition, figure 5 evidences that in this period only managerial positions have not experienced a relevant increase of employees that have higher qualifications than those required for their roles.


```{r overeducation by occupational category table by nsec, echo=FALSE}

options(digits = 3)

n_skills_occ <- LFS_clean %>% # summary table
  filter(AGE >= 18 & AGE <= 64) %>% 
  filter(ILODEFR == 1) %>% # only people in employment
  filter(INECAC05 %in% c(1, 2)) %>% #only employees and self-employed
  group_by(year, sequence, quarter, NSEC2,sk_mm) %>% 
  summarise(count = sum(PWT)) %>% 
  group_by(year, sequence, quarter, NSEC2) %>% 
  # percentage per quarter
  mutate(percentage = count/sum(count)) %>% 
  filter(!is.na(NSEC2) & !NSEC2 == 6) %>%  # omit no answers and no apply
  filter(sk_mm == 1) %>%  #filtering by overeducated
  as_label(.)

```


```{r plot skills overeducated employees, fig.width=9, fig.height=6, fig.fullwidth=TRUE, fig.cap= "workers who have a qualification above the required for their occupation"}

p_nskills_occ <- n_skills_occ %>% 
  ggplot() + 
  geom_line(aes(x = sequence, y = percentage, colour = factor(NSEC2)), size = 0.5, show.legend = FALSE) +  
  geom_point(aes(x = sequence, y = percentage, colour = factor(NSEC2)), shape = 15, show.legend = TRUE) +
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(breaks = seq(0,0.3,0.05), limits = c(0, 0.3), labels =
                       scales::percent_format(accuracy = 1L), expand = c(0,0), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=c(1:68), position = "top",
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  # annotation
  labs(x = "Year", 
       y = "Percentage", 
       title ="Figure 5. Overeducated workers by occupational category (percentages and totals)",
       subtitle  = "",
       caption = ""
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "top", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

pskills_total_occ <- n_skills_occ %>% 
  ggplot() + 
  geom_bar(aes(x = sequence, y = count, fill = factor(NSEC2)), stat = "identity", position = "dodge", width=0.9) +   
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_x_continuous(breaks=c(1:68),
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0,3000000,500000), limits = c(0,3000000), labels = comma, expand = c(0,0), sec.axis = dup_axis()) +
  
  # annotation
  labs(x = "Year", 
       y = "Total", 
       title = "",
       #subtitle  = "Totals based on people in employment between 2006 and 2022",
       #caption = c("Note: People in employment (employees and self-employed) between 2006 and 2022")
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "none", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))


p_nskills_occ / pskills_total_occ 

```

###  Work arrangement

A larger proportion of employees under a "non-permanent" work arrangement are overeducated than those with a "permanent" contract. Nonetheless, figure 6 exhibits that the former experiences variations throughout each year whereas the latter has had a steady increase between 2006 and 2022.   

```{r overeducation by work arrangement table by STAT, echo=FALSE}

options(digits = 3)

n_skills_wa <- LFS_clean %>% # summary table
  filter(AGE >= 18 & AGE <= 64) %>% 
  filter(ILODEFR == 1) %>% # only people in employment
  filter(INECAC05 %in% c(1, 2)) %>% #only employees and self-employed
  group_by(year, sequence, quarter, JOBTYP,sk_mm) %>% 
  summarise(count = sum(PWT)) %>% 
  group_by(year, sequence, quarter, JOBTYP) %>% 
  # percentage per quarter
  mutate(percentage = count/sum(count)) %>% 
  filter(!is.na(JOBTYP)) %>%  # omit no answers and no apply
  filter(sk_mm == 1) %>%  #filtering by overeducated
  as_label(.)

```


```{r plot skills overeducated employees, fig.width=9, fig.height=6, fig.fullwidth=TRUE, fig.cap= "workers who have a qualification above the required for their occupation"}

p_nskills_wa <- n_skills_wa %>% 
  ggplot() + 
  geom_line(aes(x = sequence, y = percentage, colour = factor(JOBTYP)), size = 0.5, show.legend = FALSE) +  
  geom_point(aes(x = sequence, y = percentage, colour = factor(JOBTYP)), shape = 15, show.legend = TRUE) +
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(breaks = seq(0,0.3,0.05), limits = c(0, 0.3), labels =
                       scales::percent_format(accuracy = 1L), expand = c(0,0), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=c(1:68), position = "top",
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  # annotation
  labs(x = "Year", 
       y = "Percentage", 
       title ="Figure 6. Overeducated workers by work arrangement (percentages and totals)",
       subtitle  = "",
       caption = ""
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "top", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

pskills_total_wa <- n_skills_wa %>% 
  ggplot() + 
  geom_bar(aes(x = sequence, y = count, fill = factor(JOBTYP)), stat = "identity", position = "dodge", width=0.9) +   
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_x_continuous(breaks=c(1:68),
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0,3500000,500000), limits = c(0,3500000), labels = comma, expand = c(0,0), sec.axis = dup_axis()) +
  
  # annotation
  labs(x = "Year", 
       y = "Total", 
       title = "",
       #subtitle  = "Totals based on people in employment between 2006 and 2022",
       #caption = c("Note: People in employment (employees and self-employed) between 2006 and 2022")
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "none", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

p_nskills_wa / pskills_total_wa

```

###  Flexible employment


```{r overeducation by work arrangement table by STAT, echo=FALSE}

options(digits = 3)

n_skills_fled <- LFS_clean %>% # summary table
  filter(AGE >= 18 & AGE <= 64) %>% 
  filter(ILODEFR == 1) %>% # only people in employment
  filter(INECAC05 %in% c(1, 2)) %>% #only employees and self-employed
  group_by(year, sequence, quarter, FLED,sk_mm) %>% 
  summarise(count = sum(PWT)) %>% 
  group_by(year, sequence, quarter, FLED) %>% 
  # percentage per quarter
  mutate(percentage = count/sum(count)) %>% 
  filter(!is.na(JOBTYP)) %>%  # omit no answers and no apply
  filter(sk_mm == 1) %>%  #filtering by overeducated
  as_label(.)

```


```{r plot skills overeducated employees, fig.width=9, fig.height=6, fig.fullwidth=TRUE, fig.cap= "workers who have a qualification above the required for their occupation"}

p_nskills_fled <- n_skills_fled %>% 
  ggplot() + 
  geom_line(aes(x = sequence, y = percentage, colour = factor(FLED)), size = 0.5, show.legend = FALSE) +  
  geom_point(aes(x = sequence, y = percentage, colour = factor(FLED)), shape = 15, show.legend = TRUE) +
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(breaks = seq(0,0.3,0.05), limits = c(0, 0.3), labels =
                       scales::percent_format(accuracy = 1L), expand = c(0,0), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=c(1:68), position = "top",
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  # annotation
  labs(x = "Year", 
       y = "Percentage", 
       title ="Figure 7. Overeducated workers in flexible employment (percentages and totals)",
       subtitle  = "",
       caption = ""
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "top", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

pskills_total_fled <- n_skills_fled %>% 
  ggplot() + 
  geom_bar(aes(x = sequence, y = count, fill = factor(FLED)), stat = "identity", position = "dodge", width=0.9) +   
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_x_continuous(breaks=c(1:68),
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0,3500000,500000), limits = c(0,3500000), labels = comma, expand = c(0,0), sec.axis = dup_axis()) +
  
  # annotation
  labs(x = "Year", 
       y = "Total", 
       title = "",
       #subtitle  = "Totals based on people in employment between 2006 and 2022",
       #caption = c("Note: People in employment (employees and self-employed) between 2006 and 2022")
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "none", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

p_nskills_fled / pskills_total_fled

```


## Sectoral division 

Lastly, the sectoral division illustrates the distribution of skill-related underemployment by UK's nations and regions as well as its industry sectors. It is important to note that this report focuses on the industry sectors and regions that contain the cities related to the current research project. 

### Region

In terms of region, it is possible to observe that the four regions from the cities involved in the current research have experienced between 2006 and 2022 a steady increase of the proportion of their population that has higher qualifications than those required by their jobs. Futhermore, currently 13% of the population of the "Greater Manchester" and "Strathclyde" and "South West" is categorised as skills-related undermployed while 11% of the population from the "East Midlands" region is in this condition.   

```{r overeducation by region table by REGWKR, echo=FALSE}

options(digits = 3)

n_skills_reg <- LFS_clean %>% # summary table
  filter(AGE >= 18 & AGE <= 64) %>% 
  filter(ILODEFR == 1) %>% # only people in employment
  filter(INECAC05 %in% c(1, 2)) %>% #only employees and self-employed
  group_by(year, sequence, quarter, REGWKR,sk_mm) %>% 
  summarise(count = sum(PWT)) %>% 
  group_by(year, sequence, quarter, REGWKR) %>% 
  # percentage per quarter
  mutate(percentage = count/sum(count)) %>% 
  filter(REGWKR %in% c(6,13,16,20) &!is.na(REGWKR)) %>%  # omit no answers and no apply
  filter(sk_mm == 1) %>%  #filtering by overeducated
  as_label(.)

```


```{r plot skills overeducated employees, fig.width=9, fig.height=6, fig.fullwidth=TRUE, fig.cap= "workers who have a qualification above the required for their occupation"}

p_nskills_reg <- n_skills_reg %>% 
  ggplot() + 
  geom_line(aes(x = sequence, y = percentage, colour = factor(REGWKR)), size = 0.5, show.legend = FALSE) +  
  geom_point(aes(x = sequence, y = percentage, colour = factor(REGWKR)), shape = 15, show.legend = TRUE) +
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(breaks = seq(0,0.30,0.05), limits = c(0, 0.30), labels =
                       scales::percent_format(accuracy = 1L), expand = c(0,0), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=c(1:68), position = "top",
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  # annotation
  labs(x = "Year", 
       y = "Percentage", 
       title ="Figure 8. Overeducated workers by region (percentages and totals)",
       subtitle  = "",
       caption = "Nottingham = East Midlands, Bristol = South West, Manchaster = Greater Manchester, Glasgow = Strathclyde"
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "top", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

pskills_total_reg <- n_skills_reg %>% 
  ggplot() + 
  geom_bar(aes(x = sequence, y = count, fill = factor(REGWKR)), stat = "identity", position = "dodge", width=0.9) +   
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_x_continuous(breaks=c(1:68),
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0,2000000,500000), limits = c(0,2000000), labels = comma, expand = c(0,0), sec.axis = dup_axis()) +
  
  # annotation
  labs(x = "Year", 
       y = "Total", 
       title = "",
       #subtitle  = "Totals based on people in employment between 2006 and 2022",
       #caption = c("Note: People in employment (employees and self-employed) between 2006 and 2022")
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "none", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

p_nskills_reg / pskills_total_reg

```

### Nation

Likewise, between 2006 and 2022 the four nations from the UK have experienced a steady increase of skills-related underemployees. In this regard, Scotland is currently the country from the UK with largest percentage of overeducated employees, with a 2% above the other three nations.

```{r overeducation by nation table by country2, echo=FALSE}

options(digits = 3)

n_skills_con <- LFS_clean %>% # summary table
  filter(AGE >= 18 & AGE <= 64) %>% 
  filter(ILODEFR == 1) %>% # only people in employment
  filter(INECAC05 %in% c(1, 2)) %>% #only employees and self-employed
  group_by(year, sequence, quarter, COUNTRY2,sk_mm) %>% 
  summarise(count = sum(PWT)) %>% 
  group_by(year, sequence, quarter, COUNTRY2) %>% 
  # percentage per quarter
  mutate(percentage = count/sum(count)) %>% 
  filter(!is.na(COUNTRY2)) %>%  # omit no answers and no apply
  filter(sk_mm == 1) %>%  #filtering by overeducated
  as_label(.)

```


```{r plot skills overeducated employees, fig.width=9, fig.height=6, fig.fullwidth=TRUE, fig.cap= "workers who have a qualification above the required for their occupation"}

p_nskills_con <- n_skills_con %>% 
  ggplot() + 
  geom_line(aes(x = sequence, y = percentage, colour = factor(COUNTRY2)), size = 0.5, show.legend = FALSE) +  
  geom_point(aes(x = sequence, y = percentage, colour = factor(COUNTRY2)), shape = 15, show.legend = TRUE) +
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(breaks = seq(0,0.30,0.05), limits = c(0, 0.30), labels =
                       scales::percent_format(accuracy = 1L), expand = c(0,0), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=c(1:68), position = "bottom",
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  # annotation
  labs(x = "Year", 
       y = "Percentage", 
       title ="Figure 9. Overeducated workers by nation",
       subtitle  = "",
       caption = ""
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "top", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))


p_nskills_con 

```

### Industry 

Finally, figure 10 shows that between 2006 and 2022 the percentage of overeducated employees has been higher in the retail industry than the human health. Nonetheless, it is also possible observed that both activities have experienced a similar development during this period. 


```{r overeducation by industry sector table by ind1, echo=FALSE}

options(digits = 3)

n_skills_ind <- LFS_clean %>% # summary table
  filter(AGE >= 18 & AGE <= 64) %>% 
  filter(ILODEFR == 1) %>% # only people in employment
  filter(INECAC05 %in% c(1, 2)) %>% #only employees and self-employed
  group_by(year, sequence, quarter, ind1,sk_mm) %>% 
  summarise(count = sum(PWT)) %>% 
  group_by(year, sequence, quarter, ind1) %>% 
  # percentage per quarter
  mutate(percentage = count/sum(count)) %>% 
  filter(ind1 %in% c(7, 17) & !is.na(ind1)) %>%  # omit no answers and no apply
  filter(sk_mm == 1) %>%  #filtering by overeducated
  as_label(.)


```


```{r plot skills overeducated employees, fig.width=9, fig.height=6, fig.fullwidth=TRUE, fig.cap= "workers who have a qualification above the required for their occupation"}

p_nskills_ind <- n_skills_ind %>% 
  ggplot() + 
  geom_line(aes(x = sequence, y = percentage, colour = factor(ind1)), size = 0.5, show.legend = FALSE) +  
  geom_point(aes(x = sequence, y = percentage, colour = factor(ind1)), shape = 15, show.legend = TRUE) +
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(breaks = seq(0,0.30,0.05), limits = c(0, 0.30), labels =
                       scales::percent_format(accuracy = 1L), expand = c(0,0), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=c(1:68), position = "top",
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  # annotation
  labs(x = "Year", 
       y = "Percentage", 
       title ="Figure 10. Overeducated workers by industry (percentages and totals)",
       subtitle  = "",
       caption = "Filtered by retail and human health economic activities"
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "top", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

pskills_total_ind <- n_skills_ind %>% 
  ggplot() + 
  geom_bar(aes(x = sequence, y = count, fill = factor(ind1)), stat = "identity", position = "dodge", width=0.9) +   
  geom_vline(xintercept = 4.5, color = "#c9c9c9") + # gridline 2006
  geom_vline(xintercept = 8.5, color = "#c9c9c9") + # gridline 2007
  geom_vline(xintercept = 12.5, color = "#c9c9c9") + # gridline 2008
  geom_vline(xintercept = 16.5, color = "#c9c9c9") + # gridline 2009
  geom_vline(xintercept = 20.5, color = "#c9c9c9") + # gridline 2010
  geom_vline(xintercept = 24.5, color = "#c9c9c9") + # gridline 2011
  geom_vline(xintercept = 28.5, color = "#c9c9c9") + # gridline 2012
  geom_vline(xintercept = 32.5, color = "#c9c9c9") + # gridline 2013
  geom_vline(xintercept = 36.5, color = "#c9c9c9") + # gridline 2014
  geom_vline(xintercept = 40.5, color = "#c9c9c9") + # gridline 2015
  geom_vline(xintercept = 44.5, color = "#c9c9c9") + # gridline 2016
  geom_vline(xintercept = 48.5, color = "#c9c9c9") + # gridline 2017
  geom_vline(xintercept = 52.5, color = "#c9c9c9") + # gridline 2018
  geom_vline(xintercept = 56.5, color = "#c9c9c9") + # gridline 2019
  geom_vline(xintercept = 60.5, color = "#c9c9c9") + # gridline 2020
  geom_vline(xintercept = 64.5, color = "#c9c9c9") + # gridline 2021

  # scale and colour
  scale_fill_discrete_qualitative(palette = "Dark 3") +
  scale_x_continuous(breaks=c(1:68),
                     labels=c("","2006","", "", "", "2007", "", "", "", "2008", "", "", "", "2009", "", 
                            "", "", "2010", "", "", "", "2011", "", "", "", "2012", "", "", 
                            "", "2013", "", "", "", "2014", "", "", "", "2015", "", "", "", 
                            "2016", "", "", "", "2017", "", "", "", "2018", "", "", "", "2019", "",
                            "", "", "2020", "", "", "", "2021", "", "", "", "2022", "", ""), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(0,3000000,500000), limits = c(0,3000000), labels = comma, expand = c(0,0), sec.axis = dup_axis()) +
  
  # annotation
  labs(x = "Year", 
       y = "Total", 
       title = "",
       #subtitle  = "Totals based on people in employment between 2006 and 2022",
       #caption = c("Note: People in employment (employees and self-employed) between 2006 and 2022")
       ) +

  # theme
  theme_economist_white(gray_bg = FALSE, base_family = "Lato") +
  theme(plot.margin = unit(c(0, 0, 0, 0), "lines"),
        plot.title = element_text(size = 13, margin = ggplot2::margin(5, 0, 0, 0)),
        plot.subtitle = element_text(size = 12, hjust = 0, margin = ggplot2::margin(0, 0, 0, 0)),
        plot.caption = element_text(size = 10, hjust = 1, margin = ggplot2::margin(2, 0, 2, 0)),
        axis.title.x = element_text(margin = ggplot2::margin(t = 8), size = 10),
        axis.title.y = element_text(margin = ggplot2::margin(r = 2), size = 10),
        axis.text.x = element_text(size = 10, margin = margin(t = 2)),
        axis.text.y = element_text(size = 10),
        axis.ticks.length.x = unit(0.1, "cm"), 
        axis.text.y.right =  element_text(margin = margin(l = 4)),
        axis.title.y.right = element_blank(),
        legend.position = "none", 
        legend.title = element_blank(),
        legend.text = element_text(size = 11),
        panel.grid.major = element_line(color = "gray90", linewidth = .5)) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE, override.aes = list(size = 5)))

p_nskills_ind / pskills_total_ind

```

